git_options:
  submodules:
    include_match: ^.*$
trial_attachments:
  screenshots:
    include_match: 'tmp\/.+\.png$'
    content_type: image/png
  logs:
    include_match: 'logs\/.+\.log$'
    content_type: text/plain
traits:
  asdf: true
  ci-executor-madek: true
  # libgconf-2-4: true
  # ubuntu-desktop: true
  # wine: true
  # xorg: true
scripts:
  include:
    - cider-ci/bundle-script.yml
  install-npm-packages:
    body: |
      #!/usr/bin/env bash
      ./bin/env/nodejs-setup
      npm clean-install
  build-stylesheets:
    body:  bin/build-stylesheets-prod*
    start_when:
      install-npm-packages has passed:
        script_key: install-npm-packages
  build-electron-front:
    body: |
      #!/usr/bin/env bash
      set -euo pipefail
      ./bin/build-electron-front-prod
    start_when:
      install-npm-packages has passed:
        script_key: install-npm-packages
  build-electron-main:
    body: |
      #!/usr/bin/env bash
      set -euo pipefail
      ./bin/build-electron-main-prod
    start_when:
      install-npm-packages has passed:
        script_key: install-npm-packages
  build-jvm-main:
    body: |
      #!/usr/bin/env bash
      ./bin/build-jvm-main-prod
  build-components-done:
    # just a meta script to model dependencies easier
    body: exit 0
    start_when:
      build jvm server has passed:
        script_key: build-jvm-main
      build electron-front has passed:
        script_key: build-electron-front
      build electron-main has passed:
        script_key: build-electron-main
      stylesheets have been built:
        script_key: build-stylesheets
  build-mac-os:
    body: |
      #!/usr/bin/env bash
      set -euo pipefail
      ./bin/build-mac-os
      zip -r Madek-Exporter_Mac-OS.zip madek-exporter-darwin-x64
      cp Madek-Exporter_Mac-OS.zip /tmp/Madek-Exporter_Mac-OS_${CIDER_CI_TREE_ID}.zip
    start_when:
      build-components has passed:
        script_key: build-components-done
  build-windows:
    ignore_state: true
    body: |
      #!/usr/bin/env bash
      set -euo pipefail
      echo "THE STATE OF THIS SCRIPT IS IGNORED SINCE THE WINDOWS BUILD FAILS ON NEWER SYSTEMS"
      ./bin/build-win
      zip -r Madek-Exporter_Windows.zip madek-exporter-win32-x64
      # cp Madek-Exporter_Linux.zip /tmp/Madek-Exporter_Linux_${CIDER_CI_TREE_ID}.zip
      #
    start_when:
      build-components has passed:
        script_key: build-components-done
  build-linux:
    body: |
      #!/usr/bin/env bash
      set -euo pipefail
      ./bin/build-linux
      zip -r Madek-Exporter_Linux.zip madek-exporter-linux-x64
      # cp Madek-Exporter_Linux.zip /tmp/Madek-Exporter_Linux_${CIDER_CI_TREE_ID}.zip
    start_when:
      build-components has passed:
        script_key: build-components-done
  test:
    ignore_state: true
    start_when:
      bundle has passed:
        script_key: bundle
      build-linux has passed:
        script_key: build-linux
    body: |
      #!/usr/bin/env bash
      set -euo pipefail
      echo "THE STATE OF THIS SCRIPT IS IGNORED SINCE THE CHROMEDRIVER CRASHES ON NEWER SYSTEMS"
      which chromedriver
      chromedriver --version
      xvfb-run -a -e logs/xvfb.log ./bin/rspec spec
